name: update sysdig and agent charts for new agent release

scms:
  github:
    kind: "github"
    spec:
      user: "updatecli"
      email: "updatecli@sysdig.com"
      owner: "sysdiglabs"
      repository: "charts"
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: draios-jenkins
      branch: "master"

sources:
  checkAgentReleaseEnv:
    kind: shell
    spec:
      command: echo $AGENT_RELEASE
      environments:
        - name: AGENT_RELEASE
          value: '{{ requiredEnv "AGENT_RELEASE" }}'

targets:
  updateAgentChartValues:
    kind: yaml
    scmid: github
    spec:
      file: "charts/agent/values.yaml"
      key: "$.image.tag"

  bumpAgentChart:
    kind: helmchart
    scmid: github
    dependson:
      - updateAgentChartValues
    spec:
      name: "charts/agent"
      file: Chart.yaml
      key: "$.appVersion"
      versionincrement: patch

  updateSysdigChartValues:
    kind: yaml
    scmid: github
    spec:
      file: "charts/sysdig/values.yaml"
      key: "$.image.tag"

  bumpSysdigChart:
    kind: helmchart
    scmid: github
    dependson:
      - updateSysdigChartValues
    spec:
      name: "charts/sysdig/"
      file: Chart.yaml
      key: "$.appVersion"
      versionincrement: patch
