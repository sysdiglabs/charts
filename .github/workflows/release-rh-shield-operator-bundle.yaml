name: Build Shield Operator Bundle

on:
  pull_request:
    types: [closed]
    branches:
      - main
    paths:
      - 'rh-shield-operator/bundle/**'

jobs:
  validate-and-prepare:
    name: Validate Bundle PR
    runs-on: ubuntu-latest
    # Only run if PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    outputs:
      release_version: ${{ steps.get-version.outputs.release_version }}
      image_tag_base: ${{ steps.get-image-base.outputs.image_tag_base }}
    steps:
      - name: Checkout charts repo
        uses: actions/checkout@v6
        with:
          ref: main  # Use the merged version
          fetch-depth: '1'

      - name: Get Operator Version
        id: get-version
        run: |
          VERSION=$(awk '/^VERSION/{print $3}' Makefile)
          if [ -z "$VERSION" ]; then
            echo "‚ùå ERROR: VERSION not found in Makefile"
            exit 1
          fi
          echo "‚úÖ Bundle version: $VERSION"
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT
        working-directory: rh-shield-operator

      - name: Get Image Tag Base
        id: get-image-base
        run: |
          IMAGE_TAG_BASE=$(awk '/^IMAGE_TAG_BASE/{print $3}' Makefile)
          if [ -z "$IMAGE_TAG_BASE" ]; then
            echo "‚ùå ERROR: IMAGE_TAG_BASE not found in Makefile"
            exit 1
          fi
          echo "‚úÖ Image tag base: $IMAGE_TAG_BASE"
          echo "image_tag_base=$IMAGE_TAG_BASE" >> $GITHUB_OUTPUT
        working-directory: rh-shield-operator

  build-operator-bundle:
    name: Build and Push Bundle Image
    runs-on: ubuntu-latest
    needs: validate-and-prepare
    outputs:
      bundle_image: ${{ steps.set-bundle-image.outputs.bundle_image }}
    steps:
      - name: Checkout charts repo
        uses: actions/checkout@v6
        with:
          ref: main  # Ensure we're using the merged version
          fetch-depth: '1'

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_USERNAME }}
          password: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_PASSWORD }}

      - name: Set Bundle Image
        id: set-bundle-image
        run: |
          IMAGE_TAG_BASE="${{ needs.validate-and-prepare.outputs.image_tag_base }}"
          BUNDLE_IMAGE="${IMAGE_TAG_BASE}-bundle:v${{ needs.validate-and-prepare.outputs.release_version }}"
          echo "bundle_image=$BUNDLE_IMAGE" >> $GITHUB_OUTPUT
          echo "Building bundle image: $BUNDLE_IMAGE"
        working-directory: rh-shield-operator

      - name: Build and Push Bundle Image
        run: |
          make bundle-build bundle-push
        working-directory: rh-shield-operator
        env:
          VERSION: ${{ needs.validate-and-prepare.outputs.release_version }}
          IMAGE_TAG_BASE: ${{ needs.validate-and-prepare.outputs.image_tag_base }}

      - name: Verify Bundle Image
        run: |
          BUNDLE_IMAGE="${{ steps.set-bundle-image.outputs.bundle_image }}"

          # Pull the bundle image to verify it was pushed
          docker pull "$BUNDLE_IMAGE"

          echo "‚úÖ Bundle image built and pushed successfully: $BUNDLE_IMAGE"

  notify-completion:
    name: Notify Bundle Release Completion
    runs-on: ubuntu-latest
    needs:
      - validate-and-prepare
      - build-operator-bundle
    if: always()
    steps:
      - name: Report Success
        if: needs.build-operator-bundle.result == 'success'
        run: |
          echo "üéâ Bundle Release Workflow Completed Successfully"
          echo ""
          echo "Version: v${{ needs.validate-and-prepare.outputs.release_version }}"
          echo "Bundle Image: ${{ needs.build-operator-bundle.outputs.bundle_image }}"
          echo ""
          echo "The rh-shield-operator release is now complete!"

      - name: Report Failure
        if: needs.build-operator-bundle.result == 'failure'
        run: |
          echo "‚ùå Bundle Release Workflow Failed"
          echo ""
          echo "Version: v${{ needs.validate-and-prepare.outputs.release_version }}"
          echo "Build Status: ${{ needs.build-operator-bundle.result }}"
          echo ""
          echo "Check workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1

      - name: Comment on PR with Results
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          if [ "${{ needs.build-operator-bundle.result }}" == "success" ]; then
            gh pr comment "$PR_NUMBER" \
              --body "‚úÖ **Bundle Build Completed**

          The bundle image has been built successfully!

          - Bundle Image: \`${{ needs.build-operator-bundle.outputs.bundle_image }}\`
          - Workflow: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          üéâ **Release v${{ needs.validate-and-prepare.outputs.release_version }} is complete!**
          "
          else
            gh pr comment "$PR_NUMBER" \
              --body "‚ùå **Bundle Build Failed**

          There was an error building the bundle image.

          - Build Status: ${{ needs.build-operator-bundle.result }}
          - Workflow: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          Please check the workflow logs for details.
          "
          fi
