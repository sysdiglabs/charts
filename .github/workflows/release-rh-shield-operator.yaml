name: Build and Push the Shield Operator

on:
  workflow_dispatch:

jobs:
  validate-prerequisites:
    name: Validate Prerequisites
    runs-on: ubuntu-latest
    outputs:
      release_version: ${{ steps.get-operator-version.outputs.release_version }}
      image_tag_base: ${{ steps.get-image-base.outputs.image_tag_base }}
      should_skip: ${{ steps.check-existing.outputs.should_skip }}
    steps:
      - name: Checkout charts repo
        uses: actions/checkout@v6
        with:
          fetch-depth: '1'

      - name: Get Operator Version
        id: get-operator-version
        run: |
          VERSION=$(awk '/^VERSION/{print $3}' Makefile)
          if [ -z "$VERSION" ]; then
            echo "‚ùå ERROR: VERSION not found in Makefile"
            exit 1
          fi
          echo "‚úÖ Discovered release version is $VERSION"
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT
        working-directory: rh-shield-operator

      - name: Get Image Tag Base
        id: get-image-base
        run: |
          IMAGE_TAG_BASE=$(awk '/^IMAGE_TAG_BASE/{print $3}' Makefile)
          if [ -z "$IMAGE_TAG_BASE" ]; then
            echo "‚ùå ERROR: IMAGE_TAG_BASE not found in Makefile"
            exit 1
          fi
          echo "‚úÖ Image tag base: $IMAGE_TAG_BASE"
          echo "image_tag_base=$IMAGE_TAG_BASE" >> $GITHUB_OUTPUT
        working-directory: rh-shield-operator

#      - name: Login to Docker registry
#        uses: docker/login-action@v3
#        with:
#          registry: quay.io
#          username: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_USERNAME }}
#          password: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_PASSWORD }}
#
#      - name: Check if Version Already Released
#        id: check-existing
#        run: |
#          # Check if this version already exists in the registry
#          IMAGE="${{ steps.get-image-base.outputs.image_tag_base }}:v${{ steps.get-operator-version.outputs.release_version }}"
#
#          echo "Checking if $IMAGE already exists..."
#
#          # This will fail if image doesn't exist, which is what we want
#          if docker manifest inspect "$IMAGE" > /dev/null 2>&1; then
#            echo "‚ö†Ô∏è WARNING: Image $IMAGE already exists in registry"
#            echo "should_skip=true" >> $GITHUB_OUTPUT
#          else
#            echo "‚úÖ Version is new, proceeding with build"
#            echo "should_skip=false" >> $GITHUB_OUTPUT
#          fi

  build-operator:
    name: Build the Operator Image
    runs-on: ubuntu-latest
    needs: validate-prerequisites
    if: needs.validate-prerequisites.outputs.should_skip != 'true'
    outputs:
      image_digest: ${{ steps.get-digest.outputs.digest }}
      image_tag: ${{ steps.set-image-tag.outputs.image_tag }}
    steps:
      - name: Checkout charts repo
        uses: actions/checkout@v6
        with:
          fetch-depth: '1'

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_USERNAME }}
          password: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_PASSWORD }}

      - name: Set Image Tag
        id: set-image-tag
        run: |
          IMAGE_TAG="${{ needs.validate-prerequisites.outputs.image_tag_base }}:v${{ needs.validate-prerequisites.outputs.release_version }}"
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Building image: $IMAGE_TAG"

      - name: Build and Push Operator Image
        id: build-push
        run: |
          make docker-build docker-push
        working-directory: rh-shield-operator
        env:
          VERSION: ${{ needs.validate-prerequisites.outputs.release_version }}
          IMAGE_TAG_BASE: ${{ needs.validate-prerequisites.outputs.image_tag_base }}

      - name: Get Image Digest
        id: get-digest
        run: |
          IMAGE_TAG="${{ steps.set-image-tag.outputs.image_tag }}"

          # Pull the image to get its digest
          docker pull "$IMAGE_TAG"

          # Get the full digest reference
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_TAG")

          if [ -z "$DIGEST" ]; then
            echo "‚ùå ERROR: Failed to get image digest"
            exit 1
          fi

          echo "‚úÖ Image digest: $DIGEST"
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

  certify-operator-image:
    name: Certify the Operator Image with Preflight
    runs-on: ubuntu-latest
    needs:
      - build-operator
      - validate-prerequisites
    steps:
      - name: Checkout charts repo
        uses: actions/checkout@v6
        with:
          fetch-depth: '1'

      - name: Install Preflight
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          source: "github"
          preflight: "latest"
          github_pat: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Preflight checks
        run: |
          IMAGE_TAG="${{ needs.build-operator.outputs.image_tag }}"

          echo "Running Preflight certification on: $IMAGE_TAG"

          preflight check container \
            "$IMAGE_TAG" \
            --pyxis-api-token ${{ secrets.RH_SHIELD_OPERATOR_PYXIS_API_TOKEN }} \
            --certification-component-id ${{ secrets.RH_SHIELD_OPERATOR_CERTIFICATION_PROJECT_ID }}

          echo "‚úÖ Operator image certification completed"

  generate-bundle-pr:
    name: Generate and Submit Bundle PR
    runs-on: ubuntu-latest
    needs:
      - build-operator
      - validate-prerequisites
    outputs:
      pr_number: ${{ steps.open-pr.outputs.pull-request-number }}
      pr_url: ${{ steps.open-pr.outputs.pull-request-url }}
    steps:
      - name: Checkout charts repo
        uses: actions/checkout@v6
        with:
          fetch-depth: '1'

      - name: Login to Docker registry
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_USERNAME }}
          password: ${{ secrets.QUAY_RH_SHIELD_OPERATOR_PASSWORD }}

      - name: Generate Bundle Content
        # When using 'USE_IMAGE_DIGEST', the 'make bundle' command inspects the live operator image from the registry
        # to generate the image digest. As a result, this step must be after the operator image has been
        # generated and pushed to the registry.
        run: |
          echo "Generating bundle with image digest: ${{ needs.build-operator.outputs.image_digest }}"
          USE_IMAGE_DIGESTS=true make bundle
        working-directory: rh-shield-operator
        env:
          VERSION: ${{ needs.validate-prerequisites.outputs.release_version }}
          IMG: ${{ needs.build-operator.outputs.image_digest }}
          IMAGE_TAG_BASE: ${{ needs.validate-prerequisites.outputs.image_tag_base }}

      - name: Set Labels and Annotations required for Certification on the Bundle
        uses: mikefarah/yq@v4
        with:
          cmd: |
            yq e -i '.metadata.name |= sub("rh-shield-operator", "sysdig-shield-operator")' rh-shield-operator/bundle/manifests/rh-shield-operator.clusterserviceversion.yaml
            yq e -i '.annotations."operators.operatorframework.io.bundle.package.v1" |= sub("rh-shield-operator", "sysdig-shield-operator")' rh-shield-operator/bundle/metadata/annotations.yaml
            yq e -i '.metadata.annotations.containerImage = (.spec.relatedImages[] | select(.name == "manager").image)' rh-shield-operator/bundle/manifests/rh-shield-operator.clusterserviceversion.yaml
            yq e -i '.metadata.annotations += {
              "features.operators.openshift.io/cnf": "false",
              "features.operators.openshift.io/cni": "false",
              "features.operators.openshift.io/csi": "false",
              "features.operators.openshift.io/disconnected": "false",
              "features.operators.openshift.io/fips-compliant": "false",
              "features.operators.openshift.io/proxy-aware": "false",
              "features.operators.openshift.io/tls-profiles": "false",
              "features.operators.openshift.io/token-auth-aws": "false",
              "features.operators.openshift.io/token-auth-azure": "false",
              "features.operators.openshift.io/token-auth-gcp": "false"
            }' rh-shield-operator/bundle/manifests/rh-shield-operator.clusterserviceversion.yaml
            yq e -i '.annotations."com.redhat.openshift.versions" = "v4.8-v4.17"' rh-shield-operator/bundle/metadata/annotations.yaml

      - name: Open Pull Request for Bundle update
        uses: peter-evans/create-pull-request@v7
        id: open-pr
        with:
          token: ${{ secrets.TOOLS_JENKINS_ADMIN_ACCESS_GITHUB_TOKEN }}
          commit-message: "chore(rh-shield-operator): update bundle for rh-shield-operator:v${{ needs.validate-prerequisites.outputs.release_version }}"
          title: "chore(rh-shield-operator): update bundle for rh-shield-operator:v${{ needs.validate-prerequisites.outputs.release_version }}"
          body: |
            This is an automated pull request generated as part of the rh-shield-operator release pipeline.

            ## Changes
            - Updates bundle metadata using the newly published Operator image
            - Generates image checksum using digest: `${{ needs.build-operator.outputs.image_digest }}`
            - Adjusts metadata required for Red Hat certification

            ## Release Information
            - **Version:** v${{ needs.validate-prerequisites.outputs.release_version }}
            - **Operator Image:** ${{ needs.build-operator.outputs.image_tag }}
            - **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ## Next Steps
            After merging this PR, the bundle image will be automatically built and certified.
          branch: bundle-update-v${{ needs.validate-prerequisites.outputs.release_version }}
          delete-branch: true
          labels: |
            automated PR

      - name: Comment on PR with Instructions
        if: steps.open-pr.outputs.pull-request-number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ steps.open-pr.outputs.pull-request-number }} \
            --body "‚úÖ **Operator Release Completed**

          The operator image has been built and certified successfully.

          **Review and merge this PR** to trigger the bundle build workflow.

          - Operator Image: \`${{ needs.build-operator.outputs.image_tag }}\`
          - Certification: ‚úÖ Passed
          - Workflow: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "

  notify-completion:
    name: Notify Workflow Completion
    runs-on: ubuntu-latest
    needs:
      - validate-prerequisites
      - build-operator
      - certify-operator-image
      - generate-bundle-pr
    if: always()
    steps:
      - name: Report Success
        if: needs.build-operator.result == 'success' && needs.certify-operator-image.result == 'success' && needs.generate-bundle-pr.result == 'success'
        run: |
          echo "üéâ Operator Release Workflow Completed Successfully"
          echo ""
          echo "Version: v${{ needs.validate-prerequisites.outputs.release_version }}"
          echo "Image: ${{ needs.build-operator.outputs.image_tag }}"
          echo "PR: ${{ needs.generate-bundle-pr.outputs.pr_url }}"
          echo ""
          echo "Next step: Review and merge PR #${{ needs.generate-bundle-pr.outputs.pr_number }} to build the bundle"

      - name: Report Failure
        if: needs.build-operator.result == 'failure' || needs.certify-operator-image.result == 'failure' || needs.generate-bundle-pr.result == 'failure'
        run: |
          echo "‚ùå Operator Release Workflow Failed"
          echo ""
          echo "Version: v${{ needs.validate-prerequisites.outputs.release_version }}"
          echo "Build Status: ${{ needs.build-operator.result }}"
          echo "Certification Status: ${{ needs.certify-operator-image.result }}"
          echo "PR Generation Status: ${{ needs.generate-bundle-pr.result }}"
          echo ""
          echo "Check workflow logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
