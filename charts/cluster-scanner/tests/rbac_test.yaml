suite: deployment
templates:
  - ../templates/rbac.yaml
values:
  - ../values.yaml
release:
  name: test-release
  namespace: test-ns

tests:
  - it: "generates 4 resources"
    asserts:
      - hasDocuments:
          count: 4
  - it: "generates correct ClusterRole"
    asserts:
      - equal:
          path: metadata.name
          value: test-release-cluster-scanner
        documentIndex: 0
      - isSubset:
          path: rules[0]
          content:
            apiGroups: ["", "apps", "batch", "extensions"]
            resources:
              - "namespaces"
              - "deployments"
              - "replicasets"
              - "daemonsets"
              - "statefulsets"
              - "pods"
              - "cronjobs"
              - "jobs"
              - "nodes"
              - "secrets"
            verbs: ["get", "list", "watch"]
        documentIndex: 0
  - it: "generates correct ClusterRoleBinding"
    asserts:
      - equal:
          path: metadata.name
          value: test-release-cluster-scanner
        documentIndex: 1
      - equal:
          path: roleRef.name
          value: test-release-cluster-scanner
        documentIndex: 1
      - equal:
          path: subjects[0].namespace
          value: test-ns
        documentIndex: 1
      - equal:
          path: subjects[0].name
          value: test-release-cluster-scanner
        documentIndex: 1
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 1
  - it: "generates correct Role"
    asserts:
      - equal:
          path: metadata.name
          value: test-release-cluster-scanner
        documentIndex: 2
      - equal:
          path: metadata.namespace
          value: test-ns
        documentIndex: 2
      - isSubset:
          path: rules[0]
          content:
            apiGroups: ["", "coordination.k8s.io"]
            resources:
              - "leases"
            resourceNames:
              - test-release-cluster-scanner
            verbs: ["*"]
        documentIndex: 2
      - isSubset:
          path: rules[1]
          content:
            apiGroups: ["*"]
            resources:
              - "endpoints"
            verbs: ["get", "watch", "list"]
        documentIndex: 2
      - isSubset:
          path: rules[2]
          content:
            apiGroups: ["*"]
            resources:
              - "endpoints"
            resourceNames:
              - test-release-cluster-scanner
            verbs: ["*"]
        documentIndex: 2
  - it: "overrides lease name if set for Role"
    set:
      leaderElectionLeaseNameOverride: my-override
    asserts:
      - equal:
          path: rules[0].resourceNames[0]
          value: my-override
        documentIndex: 2
  - it: "generates correct RoleBinding"
    asserts:
      - equal:
          path: metadata.name
          value: test-release-cluster-scanner
        documentIndex: 3
      - equal:
          path: metadata.namespace
          value: test-ns
        documentIndex: 3
      - equal:
          path: roleRef.name
          value: test-release-cluster-scanner
        documentIndex: 3
      - equal:
          path: subjects[0].namespace
          value: test-ns
        documentIndex: 3
      - equal:
          path: subjects[0].name
          value: test-release-cluster-scanner
        documentIndex: 3
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 3
