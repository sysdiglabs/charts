suite: deployment
templates:
  - ../templates/deployment.yaml
values:
  - ../values.yaml
release:
  name: test-release
  namespace: test-ns

tests:
  - it: "generates a deployment resource"
    asserts:
      - isKind:
          of: Deployment

  - it: "has correct name and namespace"
    asserts:
      - equal:
          path: metadata.name
          value: test-release-cluster-scanner
      - equal:
          path: metadata.namespace
          value: test-ns

  - it: "sets replicas"
    set:
      replicaCount: 42
    asserts:
      - equal:
          path: spec.replicas
          value: 42

  - it: "has RSI and ISE containers"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].name
          value: rsi
      - equal:
          path: spec.template.spec.containers[1].name
          value: ise

  - it: "has non empty default image"
    asserts:
      - not: true
        isEmpty:
          path: spec.template.spec.containers[0].image
      - not: true
        isEmpty:
          path: spec.template.spec.containers[1].image

  - it: "sets tag and repository"
    set:
      runtimeStatusIntegrator.image.registry: registry-rsi.io
      runtimeStatusIntegrator.image.repository: test.com/repo
      runtimeStatusIntegrator.image.tag: rsi
      imageSbomExtractor.image.registry: registry-ise.io
      imageSbomExtractor.image.repository: test-ise.com/repo
      imageSbomExtractor.image.tag: ise
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: registry-rsi.io/test.com/repo:rsi
      - equal:
          path: spec.template.spec.containers[1].image
          value: registry-ise.io/test-ise.com/repo:ise

  - it: "sets kubeconfig env var if set"
    set:
      global.scannerMode: "multi"
      runtimeStatusIntegrator.multiCluster.kubeconfigSecretName: "my-secret"
    asserts:
      - not: true
        isEmpty:
          path: spec.template.spec.containers[0].env[8]
      - isSubset:
          path: spec.template.spec.containers[0].env[8]
          content:
            name: SYSDIG_KUBECONFIG_CONTENT
            valueFrom:
              secretKeyRef:
                name: "my-secret"
                key: .kubeconfig

  - it: "has Recreate rollout strategy"
    asserts:
      - equal:
          path: spec.strategy.type
          value: Recreate

  - it: "sets the local registry secrets when in local mode"
    set:
      global.scannerMode: "local"
      runtimeStatusIntegrator.localCluster:
        rbac:
          allowedPullSecrets:
            namespaceOneName:
              - myDockerSecretOne
              - myDockerSecretTwo
            anotherNamespace:
              - myOtherDockerSecretOne
              - myOtherDockerSecretTwo
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[13]
          value:
            name: LOCAL_REGISTRY_SECRETS
            valueFrom:
              configMapKeyRef:
                key: local_registry_secrets
                name: test-release-cluster-scanner
                optional: true

  - it: "does not set the local registry secrets when in multi mode"
    set:
      global.scannerMode: "multi"
      runtimeStatusIntegrator.multiCluster.kubeconfigSecretName: "my-secret"
      runtimeStatusIntegrator.localCluster:
        rbac:
          allowedPullSecrets:
            namespaceOneName:
              - myDockerSecretOne
              - myDockerSecretTwo
            anotherNamespace:
              - myOtherDockerSecretOne
              - myOtherDockerSecretTwo
    asserts:
      - equal:
          path: spec.template.spec.containers[0].env[14]
          value:
            name: EVE_ENABLED
            valueFrom:
              configMapKeyRef:
                key: eve_enabled
                name: test-release-cluster-scanner
                optional: true
