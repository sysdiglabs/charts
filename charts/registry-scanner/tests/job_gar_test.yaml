suite: Registry Scanner - scanOnStart Job GAR
templates:
  - templates/job.yaml
values:
  - values-gar.yaml
tests:
  - it: checks job manifest is available when scanOnStart is enabled
    asserts:
      - containsDocument:
          kind: Job
          apiVersion: batch/v1
  - it: checks job name is same as scanOnStart.jobName
    set:
      scanOnStart:
        jobName: foo
    asserts:
      - equal:
          path: metadata.name
          value: foo-gar-us-east1
  - it: sets extraEnvVars on job
    set:
      extraEnvVars:
        - name: FOO
          value: bar
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: FOO
            value: bar
  - it: sets default labels
    asserts:
      - equal:
          path: metadata.labels['app.kubernetes.io/component']
          value: registry-scanner-orchestrator
      - equal:
          path: spec.template.metadata.labels['app.kubernetes.io/component']
          value: registry-scanner-orchestrator
  - it: ttlSecondsAfterFinished default value is set
    asserts:
      - equal:
          path: spec.ttlSecondsAfterFinished
          value: 3600
  - it: ttlSecondsAfterFinished is set
    set:
      config.scan.orchestrator.ttlSecondsAfterFinished: '0'
    asserts:
      - equal:
          path: spec.ttlSecondsAfterFinished
          value: 0
  - it: ttlSecondsAfterFinished is unset
    set:
      config.scan.orchestrator.ttlSecondsAfterFinished: ''
    asserts:
      - isNull:
          path: spec.ttlSecondsAfterFinished

  - it: multiple jobs created if registry type gar and config gar regions are set
    set:
      config:
        registryType: gar
        gar:
          regions:
          - us-east1
          - us-central
    asserts:
      - containsDocument:
          kind: Job
          apiVersion: batch/v1
          name: registry-scanner-start-test-gar-us-east1
      - containsDocument:
          kind: Job
          apiVersion: batch/v1
          name: registry-scanner-start-test-gar-us-central
      - hasDocuments:
          count: 2
      - matchRegex:
          path: spec.template.spec.containers[0].args[1]
          pattern: -docker.pkg.dev

  - it: command arguments are properly set if registry type gar and config gar regions are set
    set:
      config:
        registryType: gar
        gar:
          regions:
          - us-east1
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].args[1]
          pattern: us-east1-docker.pkg.dev
