
apiVersion: batch/v1
kind: Job
metadata:
  name: "registry-scanner-scan-on-start"
  labels:
    helm.sh/chart: registry-scanner-1.6.10
    app.kubernetes.io/instance: RELEASE-NAME
    app.kubernetes.io/name: registry-scanner
    app.kubernetes.io/component: registry-scanner-orchestrator
    app.kubernetes.io/version: "0.7.5"
    app.kubernetes.io/managed-by: Helm
    
spec:  
    backoffLimit: 0
    ttlSecondsAfterFinished: 3600
    template:
      metadata:
        name: RELEASE-NAME-registry-scanner
        labels:
              helm.sh/chart: registry-scanner-1.6.10
              app.kubernetes.io/instance: RELEASE-NAME
              app.kubernetes.io/name: registry-scanner
              app.kubernetes.io/component: registry-scanner-orchestrator
              app.kubernetes.io/version: "0.7.5"
              app.kubernetes.io/managed-by: Helm
              
      spec:
        serviceAccountName: RELEASE-NAME-registry-scanner
        securityContext:
              null
        containers:
        - name: registry-scanner
          securityContext:
                {}
          image: quay.io/sysdig/registry-scanner:job-0.7.5
          args: [ "--scan_runner=new-vm-scanner-k8s-job"]
          imagePullPolicy: Always
          resources:
                {}
          volumeMounts:
          - name: config-volume
            mountPath: /config.yaml
            subPath: config.yaml
          env:
            - name: SECURE_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: RELEASE-NAME-registry-scanner
                  key: secureAPIToken
            - name: AWS_ACCESS_KEY_ID
              value: ""
            - name: AWS_SECRET_ACCESS_KEY
              value: ""
            - name: AWS_REGION
              valueFrom:
                secretKeyRef:
                  name: RELEASE-NAME-registry-scanner
                  key: aws_region
            
            - name: GROUP_LIMIT
              value: "100"
            - name: REGISTRYSCANNER_CRONJOB_SCHEDULE
              value: "0 6 * * 6"
        restartPolicy: Never
        volumes:
        - name: config-volume
          configMap:
            name: RELEASE-NAME-registry-scanner
