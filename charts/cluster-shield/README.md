<!--


DO NOT MODIFY THIS FILE MANUALLY!!

IT'S AUTO-GENERATED vÃ­a README.tpl with pre-comit plugin
this is under construction so it must be launched manually

in the project root, run:
$ pre-commit install
$ pre-commit run -a

-->

# Cluster Shield

[Sysdig Cluster Shield](https://docs.sysdig.com/en/docs/installation/sysdig-secure/install-agent-components/kubernetes/cluster-shield/).
<br/>This chart deploys the Sysdig Cluster Shield in your Kubernetes cluster.

## TL;DR;

```
$ helm repo add sysdig https://charts.sysdig.com
$ helm repo update
$ helm upgrade --install sysdig-sysdig-cluster-shield sysdig/cluster-shield \
    --create-namespace -n sysdig-agent --version=1.3.0  \
    --set global.clusterConfig.name=CLUSTER_NAME \
    --set global.sysdig.region=SYSDIG_REGION \
    --set global.sysdig.accessKey=YOUR-KEY-HERE
```

- [Configuration](#configuration)
- [Usages](#usages)
- [Confirm Working Status](#confirm-working-status)
- [Troubleshooting](#troubleshooting)

<br/><br/>

## Introduction

This chart deploys the Sysdig Cluster Shield as a Deployment on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.


### Prerequisites

- Helm 3.6
- Sysdig AccessKey
- Sysdig Secure API Token
- Sysdig Secure API URL
- Sysdig Secure Collector


###  Installing the Chart

To install the chart  create a `values.yaml` file. Set your values and decide which features you would like to enable.
```yaml
cluster_shield:
    cluster_config:
        name: <your-cluster-name>
    features:
        admission_control:
            enabled: true
        audit:
            enabled: true
        container_vulnerability_management:
            enabled: true
        posture:
            enabled: true
    sysdig_endpoint:
        api_url: <your-api-url>
        secure_api_token: <your-secure-api-token>
        access_key: <your-access-key>
```

Then, to install it with the release name `sysdig-cluster-shield`, run:

```console
$ helm upgrade --install --atomic --create-namespace \
    -n sysdig-agent \
    -f values.yaml \
    sysdig-cluster-shield \
    sysdig/cluster-shield
```

The command deploys the Sysdig Cluster Shield on the Kubernetes cluster in the default configuration. The [configuration](#configuration) section lists the parameters that can be configured during installation.

> **Tip**: List all releases using `helm list`

### Uninstalling the Chart

To uninstall/delete the `sysdig-cluster-shield`:

```console
$ helm uninstall sysdig-cluster-shield -n sysdig-agent
```

The command removes all the Kubernetes components associated with the chart and deletes the release.

## Configuration

The following table lists the configurable parameters of the `cluster-shield` chart and their default values.

|                                         Parameter                                         |                                                                                                                                                             Description                                                                                                                                                             |                      Default                      |
|-------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------|
| global.clusterConfig.name                                                                 | The name of the cluster. Make sure to set a unique value for all the clusters being inspected.                                                                                                                                                                                                                                      | <code>""</code>                                   |
| global.proxy.httpProxy                                                                    | Sets the HTTP Proxy address.                                                                                                                                                                                                                                                                                                        | <code></code>                                     |
| global.proxy.httpsProxy                                                                   | Sets the HTTPS Proxy address.                                                                                                                                                                                                                                                                                                       | <code></code>                                     |
| global.proxy.noProxy                                                                      | Sets IPs/URLs that should not pass trough a Proxy Server.                                                                                                                                                                                                                                                                           | <code>127.0.0.1,localhost,.local,.internal</code> |
| global.image.pullSecrets                                                                  | The pull secrets used for the Cluster Shield container image                                                                                                                                                                                                                                                                        | <code>[]</code>                                   |
| global.image.pullPolicy                                                                   | The pull policy for the Cluster Shield container image                                                                                                                                                                                                                                                                              | <code>IfNotPresent</code>                         |
| global.sysdig.accessKeySecret                                                             | An existing secret containing the Sysdig Agent Access Key                                                                                                                                                                                                                                                                           | <code></code>                                     |
| global.sysdig.accessKey                                                                   | The Sysdig Agent Access Key                                                                                                                                                                                                                                                                                                         | <code></code>                                     |
| global.sysdig.apiHost                                                                     | The Sysdig Agent API Hostname                                                                                                                                                                                                                                                                                                       | <code></code>                                     |
| global.sysdig.region                                                                      | Region name for Sysdig. When no region is suitable (e.g. on-premise installations) set the value to "custom"                                                                                                                                                                                                                        | <code>"custom"</code>                             |
| global.sysdig.secureAPITokenSecret                                                        | An existing secret containing the Secure API token to access Sysdig Secure. (needed only with on-premise installations)                                                                                                                                                                                                             | <code></code>                                     |
| global.sysdig.secureAPIToken                                                              | The Secure API token to access Sysdig Secure. (needed only with on-premise installations)                                                                                                                                                                                                                                           | <code></code>                                     |
| global.gke.autopilot                                                                      | If true, overrides the Cluster Shield configuration to run on GKE Autopilot clusters.                                                                                                                                                                                                                                               | <code>false</code>                                |
| global.imageRegistry                                                                      | The image registry configuration                                                                                                                                                                                                                                                                                                    | <code></code>                                     |
| global.sslVerifyCertificate                                                               | Define if the certificate should be verified                                                                                                                                                                                                                                                                                        | <code>true</code>                                 |
| global.ssl.ca.certs                                                                       | A PEM-encoded x509 certificate. This can also be a bundle with multiple certificates.                                                                                                                                                                                                                                               | <code>[]</code>                                   |
| global.ssl.ca.keyName                                                                     | Filename that is used when creating the secret. Required if certs is provided.                                                                                                                                                                                                                                                      | <code>null</code>                                 |
| global.ssl.ca.existingCaSecret                                                            | Provide the name of an existing Secret that contains the CA required                                                                                                                                                                                                                                                                | <code>null</code>                                 |
| global.ssl.ca.existingCaSecretKeyName                                                     | Provide the filename that is defined inside the existing Secret                                                                                                                                                                                                                                                                     | <code>null</code>                                 |
| global.ssl.ca.existingCaConfigMap                                                         | Provide the name of an existing ConfigMap that contains the CA required                                                                                                                                                                                                                                                             | <code>null</code>                                 |
| global.ssl.ca.existingCaConfigMapKeyName                                                  | Provide the filename that is defined inside the existing ConfigMap                                                                                                                                                                                                                                                                  | <code>null</code>                                 |
| cluster_shield.cluster_config.name                                                        | The name of the cluster. Make sure to set a unique value for all the clusters being inspected.                                                                                                                                                                                                                                      | <code></code>                                     |
| cluster_shield.log_level                                                                  | The log level for the Cluster Shield application                                                                                                                                                                                                                                                                                    | <code>warn</code>                                 |
| cluster_shield.monitoring_port                                                            | The port that the Cluster Shield will use to expose probes and metrics                                                                                                                                                                                                                                                              | <code>8080</code>                                 |
| cluster_shield.sysdig_endpoint.access_key                                                 | The Sysdig Agent Access Key                                                                                                                                                                                                                                                                                                         | <code></code>                                     |
| cluster_shield.sysdig_endpoint.api_url                                                    | The Sysdig Agent API URL                                                                                                                                                                                                                                                                                                            | <code></code>                                     |
| cluster_shield.sysdig_endpoint.secure_api_token                                           | The Sysdig Secure API Token                                                                                                                                                                                                                                                                                                         | <code></code>                                     |
| cluster_shield.sysdig_endpoint.region                                                     | Region name for Sysdig. When no region is suitable (e.g. on-premise installations) set the value to "custom"                                                                                                                                                                                                                        | <code></code>                                     |
| cluster_shield.kubernetes.root_namespace                                                  | The system namespace of your Kubernetes cluster                                                                                                                                                                                                                                                                                     | <code>kube-system</code>                          |
| cluster_shield.features.admission_control.enabled                                         | Enable the admission control feature                                                                                                                                                                                                                                                                                                | <code>false</code>                                |
| cluster_shield.features.admission_control.deny_on_error                                   | Deny the admission of the pod if an error occurs                                                                                                                                                                                                                                                                                    | <code>false</code>                                |
| cluster_shield.features.admission_control.dry_run                                         | Enable the dry run mode                                                                                                                                                                                                                                                                                                             | <code>true</code>                                 |
| cluster_shield.features.admission_control.timeout                                         | The timeout for the admission control feature                                                                                                                                                                                                                                                                                       | <code>5</code>                                    |
| cluster_shield.features.admission_control.http_port                                       | The port that will be used to expose admission control endpoints                                                                                                                                                                                                                                                                    | <code>8443</code>                                 |
| cluster_shield.features.admission_control.container_vulnerability_management.enabled      | Enable the container vulnerability management feature on the admission control                                                                                                                                                                                                                                                      | <code>false</code>                                |
| cluster_shield.features.audit.enabled                                                     | Enable the Kubernetes Audit feature                                                                                                                                                                                                                                                                                                 | <code>false</code>                                |
| cluster_shield.features.audit.http_port                                                   | The port that will be used to expose the audit endpoints                                                                                                                                                                                                                                                                            | <code>6443</code>                                 |
| cluster_shield.features.audit.timeout                                                     | The timeout for the audit feature                                                                                                                                                                                                                                                                                                   | <code>5</code>                                    |
| cluster_shield.features.posture.enabled                                                   | Enable the posture feature                                                                                                                                                                                                                                                                                                          | <code>false</code>                                |
| cluster_shield.features.container_vulnerability_management.enabled                        | Enable the container vulnerability management feature                                                                                                                                                                                                                                                                               | <code>false</code>                                |
| cluster_shield.features.container_vulnerability_management.in_use.enabled                 | Allows to retrieve the list of running packages.                                                                                                                                                                                                                                                                                    | <code>true</code>                                 |
| cluster_shield.features.container_vulnerability_management.in_use.integration_enabled     | Allows to store the list of running packages to Sysdig backend.                                                                                                                                                                                                                                                                     | <code>false</code>                                |
| cluster_shield.features.container_vulnerability_management.local_cluster.registry_secrets | Restrict access to specific Docker secrets when Cluster Scanner is running. The default behavior is listing all secrets.                                                                                                                                                                                                            | <code>[]</code>                                   |
| cluster_shield.features.container_vulnerability_management.platform_services_enabled      | Define if the platform services are enabled                                                                                                                                                                                                                                                                                         | <code>true</code>                                 |
| cluster_shield.features.container_vulnerability_management.registry_ssl.verify            | If set to false it allows insecure connections to registries, Such as for registries with self-signed or private certificates.                                                                                                                                                                                                      | <code>true</code>                                 |
| cluster_shield.features.kubernetes_metadata.enabled                                       | Enable the Kubernetes Metadata feature                                                                                                                                                                                                                                                                                              | <code>false</code>                                |
| ca.certs                                                                                  | A PEM-encoded x509 certificate. This can also be a bundle with multiple certificates.                                                                                                                                                                                                                                               | <code>[]</code>                                   |
| ca.keyName                                                                                | Filename that is used when creating the secret. Required if certs is provided.                                                                                                                                                                                                                                                      | <code>null</code>                                 |
| ca.existingCaSecret                                                                       | Provide the name of an existing Secret that contains the CA required                                                                                                                                                                                                                                                                | <code>null</code>                                 |
| ca.existingCaSecretKeyName                                                                | Provide the filename that is defined inside the existing Secret                                                                                                                                                                                                                                                                     | <code>null</code>                                 |
| ca.existingCaConfigMap                                                                    | Provide the name of an existing ConfigMap that contains the CA required                                                                                                                                                                                                                                                             | <code>null</code>                                 |
| ca.existingCaConfigMapKeyName                                                             | Provide the filename that is defined inside the existing ConfigMap                                                                                                                                                                                                                                                                  | <code>null</code>                                 |
| run_command                                                                               | The command executed by the Cluster Shield POD                                                                                                                                                                                                                                                                                      | <code>"run-all-namespaced"</code>                 |
| image.registry                                                                            | The Sysdig Registry Scanner image registry.                                                                                                                                                                                                                                                                                         | <code>quay.io</code>                              |
| image.repository                                                                          | The Cluster Shield container image repository                                                                                                                                                                                                                                                                                       | <code>sysdig/cluster-shield</code>                |
| image.pullPolicy                                                                          | The Cluster Shield container image pull policy                                                                                                                                                                                                                                                                                      | <code></code>                                     |
| proxy.httpProxy                                                                           | Sets the HTTP Proxy address.                                                                                                                                                                                                                                                                                                        | <code></code>                                     |
| proxy.httpsProxy                                                                          | Sets the HTTPS Proxy address.                                                                                                                                                                                                                                                                                                       | <code></code>                                     |
| proxy.noProxy                                                                             | Sets IPs/URLs that should not pass trough a Proxy Server.                                                                                                                                                                                                                                                                           | <code></code>                                     |
| imagePullSecrets                                                                          | The Cluster Shield container image pull secrets                                                                                                                                                                                                                                                                                     | <code>[]</code>                                   |
| probes.liveness.initialDelaySeconds                                                       | The liveness probe initial delay                                                                                                                                                                                                                                                                                                    | <code>5</code>                                    |
| probes.liveness.periodSeconds                                                             | The liveness probe period                                                                                                                                                                                                                                                                                                           | <code>5</code>                                    |
| probes.readiness.initialDelaySeconds                                                      | The readiness probe initial delay                                                                                                                                                                                                                                                                                                   | <code>10</code>                                   |
| probes.readiness.periodSeconds                                                            | The readiness probe period                                                                                                                                                                                                                                                                                                          | <code>5</code>                                    |
| podAnnotations                                                                            | Additional pod annotations                                                                                                                                                                                                                                                                                                          | <code>{}</code>                                   |
| podLabels                                                                                 | Additional pod labels                                                                                                                                                                                                                                                                                                               | <code>{}</code>                                   |
| service.type                                                                              | The Cluster Shield service type                                                                                                                                                                                                                                                                                                     | <code>ClusterIP</code>                            |
| service.monitoring_port                                                                   | The Service port used to expose probes and metrics                                                                                                                                                                                                                                                                                  | <code></code>                                     |
| service.admission_control_port                                                            | The Service port used to expose admission control endpoints                                                                                                                                                                                                                                                                         | <code></code>                                     |
| service.audit_port                                                                        | The Service port used to expose audit endpoints                                                                                                                                                                                                                                                                                     | <code></code>                                     |
| serviceAccount.create                                                                     | Specifies whether a service account should be created                                                                                                                                                                                                                                                                               | <code>true</code>                                 |
| serviceAccount.name                                                                       | The name of the service account to use.                                                                                                                                                                                                                                                                                             | <code></code>                                     |
| serviceAccount.labels                                                                     | Additional service account labels                                                                                                                                                                                                                                                                                                   | <code>{}</code>                                   |
| serviceAccount.annotations                                                                | Additional service account annotations                                                                                                                                                                                                                                                                                              | <code>{}</code>                                   |
| resources                                                                                 |                                                                                                                                                                                                                                                                                                                                     | <code>{}</code>                                   |
| priorityClassName                                                                         | Set Cluster Shield deployment priorityClassName                                                                                                                                                                                                                                                                                     | <code></code>                                     |
| createPriorityClass                                                                       | Specifies whether a PriorityClass should be created                                                                                                                                                                                                                                                                                 | <code>false</code>                                |
| priorityClassValue                                                                        | Set Cluster Shield deployment priorityClassValue                                                                                                                                                                                                                                                                                    | <code>10</code>                                   |
| nodeSelector                                                                              | Node labels for pod assignment                                                                                                                                                                                                                                                                                                      | <code>{}</code>                                   |
| tolerations                                                                               | Tolerations for pod assignment                                                                                                                                                                                                                                                                                                      | <code>[]</code>                                   |
| affinity                                                                                  | Affinity for pod assignment                                                                                                                                                                                                                                                                                                         | <code>{}</code>                                   |
| replicaCount                                                                              | The number of replicas for the Cluster Shield deployment                                                                                                                                                                                                                                                                            | <code>2</code>                                    |
| updateStrategy.type                                                                       | The update strategy for the Cluster Shield deployment                                                                                                                                                                                                                                                                               | <code>RollingUpdate</code>                        |
| updateStrategy.rollingUpdate                                                              | The rolling update strategy for the Cluster Shield deployment                                                                                                                                                                                                                                                                       | <code>{}</code>                                   |
| onPremCompatibilityVersion                                                                | Optional parameter used to check the compatibility of cluster-shield component versions with the on-premised backend version. If you are running an on-prem version of the Sysdig backend, you MUST set this parameter with the version of Sysdig backend you are using. If you are runinng on SaaS, do NOT provide this parameter. | <code></code>                                     |
| hostNetwork                                                                               | Specifies if Cluster Shield should be started in hostNetwork mode. This field is required if you are using a custom CNI where the control plane nodes are unable to initiate network connections to the pods, for example, using Calico CNI plugin on EKS.                                                                          | <code>false</code>                                |
| dnsPolicy                                                                                 | Define Cluster Shield Pods DNS Policy                                                                                                                                                                                                                                                                                               | <code></code>                                     |
| existingTLSSecret.name                                                                    | Provide the name of an existing Secret that contains the TLS certificate required                                                                                                                                                                                                                                                   | <code></code>                                     |
| existingTLSSecret.tlsCertName                                                             | Provide the certificate filename that is defined inside the existing Secret (default tls.crt)                                                                                                                                                                                                                                       | <code></code>                                     |
| existingTLSSecret.tlsCertKeyName                                                          | Provide the certificate key filename that is defined inside the existing Secret (default tls.key)                                                                                                                                                                                                                                   | <code></code>                                     |
| existingTLSSecret.caCertName                                                              | Provide the certificate authority filename that is defined inside the existing Secret (default ca.crt)                                                                                                                                                                                                                              | <code></code>                                     |


## Running helm unit tests

The sysdiglabs/charts repository uses the following helm unittest plugin: https://github.com/quintush/helm-unittest

You can test the changes to your chart by running the test suites as follows:

```
make test
```

The helm unit tests are in the tests folder. It is recommended to add new tests as new features are added here.
