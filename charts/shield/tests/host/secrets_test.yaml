suite: Host - Secrets
templates:
  - templates/host/secrets.yaml
  - templates/host/daemonset.yaml
release:
  name: release-name
  namespace: shield-namespace
values:
  - ../values/base.yaml
tests:
  - it: Test Rapid Response secret is created when needed
    set:
      features:
        respond:
          rapid_response:
            enabled: true
      host:
        additional_settings:
          rapid_response:
            password: abc123
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        template: templates/host/secrets.yaml
      - equal:
          path: data.password
          decodeBase64: true
          value: "abc123"
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: release-name-shield-host-rapid-response
                key: password
        template: templates/host/daemonset.yaml

  - it: Test Rapid Response secret is created with correct password
    set:
      features:
        respond:
          rapid_response:
            enabled: true
            password: abc123
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        template: templates/host/secrets.yaml
      - equal:
          path: data.password
          decodeBase64: true
          value: "abc123"
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: release-name-shield-host-rapid-response
                key: password
        template: templates/host/daemonset.yaml

  - it: Test Rapid Response using existing secret for password
    set:
      features:
        respond:
          rapid_response:
            enabled: true
            password_existing_secret: existing-secret
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        not: true
        template: host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: existing-secret
                key: password
        template: templates/host/daemonset.yaml

  - it: Test Rapid Response using existing secret for password with custom key
    set:
      features:
        respond:
          rapid_response:
            enabled: true
            password_existing_secret: existing-secret
            password_existing_secret_key: custom-key
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        not: true
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: existing-secret
                key: custom-key
        template: templates/host/daemonset.yaml

  - it: Test Local Forwarder secret is not created when disabled
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-local-forwarder
          namespace: shield-namespace
        not: true
        template: host/secrets.yaml

  - it: Test Local Forwarder secret is created when enabled
    set:
      features:
        investigations:
          event_forwarder:
            enabled: true
            integrations:
              - channels:
                  - SECURE_EVENTS_POLICIES
                  - ACTIVITY_AUDIT
                configuration:
                  output: stdout
                type: LOCAL
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-local-forwarder
          namespace: shield-namespace
      - exists:
          path: data["local_forwarder_config.yaml"]
      - matchRegex:
          path: data["local_forwarder_config.yaml"]
          pattern: aW50ZWdyYXRpb25zOgotIGNoYW5uZWxzOgogIC0gU0VDVVJFX0VWRU5UU19QT0xJQ0lFUwogIC0gQUNUSVZJVFlfQVVESVQKICBjb25maWd1cmF0aW9uOgogICAgb3V0cHV0OiBzdGRvdXQKICB0eXBlOiBMT0NBTA==
    template: host/secrets.yaml
