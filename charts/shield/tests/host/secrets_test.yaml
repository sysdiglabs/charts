suite: Host - Secrets
templates:
  - templates/host/secrets.yaml
  - templates/host/daemonset.yaml
release:
  name: release-name
  namespace: shield-namespace
values:
  - ../values/base.yaml
kubernetesProvider:
  scheme:
    "v1/Secret":
      gvr:
        version: "v1"
        resource: "secrets"
      namespaced: true
  objects:
    - apiVersion: v1
      kind: Secret
      metadata:
        name: existing-secret
        namespace: shield-namespace
      data:
        password: YWJjMTIzCg== # abc123
tests:
  - it: Test Rapid Response secret is created when needed
    set:
      features:
        respond:
          rapid_response:
            enabled: true
      host:
        additional_settings:
          rapid_response:
            password: abc123
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        template: templates/host/secrets.yaml
      - equal:
          path: data.password
          decodeBase64: true
          value: "abc123"
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: release-name-shield-host-rapid-response
                key: password
        template: templates/host/daemonset.yaml

  - it: Test Rapid Response secret is created with correct password
    set:
      features:
        respond:
          rapid_response:
            enabled: true
            password: abc123
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        template: templates/host/secrets.yaml
      - equal:
          path: data.password
          decodeBase64: true
          value: "abc123"
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: release-name-shield-host-rapid-response
                key: password
        template: templates/host/daemonset.yaml

  - it: Test Rapid Response using existing secret for password
    set:
      features:
        respond:
          rapid_response:
            enabled: true
            existing_secret: existing-secret
    asserts:
      - notExists:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: existing-secret
                key: password
    template: templates/host/daemonset.yaml

  - it: Test Rapid Response using existing secret for password with custom key
    set:
      features:
        respond:
          rapid_response:
            enabled: true
            existing_secret: existing-secret
            existing_secret_password_key: custom-key
    asserts:
      - notExists:
          kind: Secret
          apiVersion: v1
          name: release-name-shield-host-rapid-response
          namespace: shield-namespace
        template: templates/host/secrets.yaml
      - equal:
          path: spec.template.spec.containers[?(@.name == "sysdig-host-shield")].env[?(@.name == "PASSWORD")]
          value:
            name: PASSWORD
            valueFrom:
              secretKeyRef:
                name: existing-secret
                key: custom-key
    template: templates/host/daemonset.yaml
