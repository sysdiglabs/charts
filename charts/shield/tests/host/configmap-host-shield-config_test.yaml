suite: Host - Configmap [host-shield.yaml]
templates:
  - templates/host/configmap.yaml
release:
  name: release-name
  namespace: shield-namespace
kubernetesProvider:
  scheme:
    "v1/Secret":
      gvr:
        version: "v1"
        resource: "secrets"
      namespaced: true
values:
  - ../values/base.yaml
tests:
  - it: Everything is disabled by default
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              detections:
                ml_policies:
                  enabled: false
            .*
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              monitor:
                app_checks:
                  enabled: false
                java_management_extensions:
                  enabled: false
                prometheus:
                  enabled: false
                statsd:
                  enabled: false
            .*
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              posture:
                host_posture:
                  enabled: false
            .*
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              respond:
                rapid_response:
                  enabled: false
            .*
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              vulnerability_management:
                host_vulnerability_management:
                  enabled: false
                in_use:
                  enabled: false
                  integration_enabled: false

  - it: Ensure Posture is enabled when requested
    set:
      features:
        posture:
          host_posture:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              posture:
                host_posture:
                  enabled: true
            .*

  - it: Ensure Host Vulnerability Management is enabled when requested
    set:
      features:
        vulnerability_management:
          host_vulnerability_management:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              vulnerability_management:
                host_vulnerability_management:
                  enabled: true
                in_use:
                  enabled: false
                  integration_enabled: false

  - it: Enable Posture and Vulnerability Management
    set:
      features:
        posture:
          host_posture:
            enabled: true
        vulnerability_management:
          host_vulnerability_management:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |-
            .*
              posture:
                host_posture:
                  enabled: true
            .*
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              vulnerability_management:
                host_vulnerability_management:
                  enabled: true
                in_use:
                  enabled: false
            .*

  - it: Enable Posture, Vulnerability Management, and set in_use to true
    set:
      features:
        posture:
          host_posture:
            enabled: true
        vulnerability_management:
          host_vulnerability_management:
            enabled: true
          in_use:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |-
            .*
              posture:
                host_posture:
                  enabled: true
            .*
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
              vulnerability_management:
                host_vulnerability_management:
                  enabled: true
                in_use:
                  enabled: true
            .*

  - it: Enable Rapid Response
    set:
      features:
        respond:
          rapid_response:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |-
            .*
              respond:
                rapid_response:
                  enabled: true
            .*

  - it: Enable ML Policies
    set:
      features:
        detections:
          ml_policies:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |-
            .*
              detections:
                ml_policies:
                  enabled: true
            .*

  - it: Enable App Checks
    set:
      features:
        monitor:
          app_checks:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                app_checks:
                  enabled: true
            .*

  - it: Enable JMX
    set:
      features:
        monitor:
          java_management_extensions:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                java_management_extensions:
                  enabled: true
            .*

  - it: Enable Prometheus
    set:
      features:
        monitor:
          prometheus:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                prometheus:
                  enabled: true
            .*

  - it: Enable StatsD
    set:
      features:
        monitor:
          statsd:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                statsd:
                  enabled: true
            .*

  - it: Enable Activity Audit
    set:
      features:
        investigations:
          activity_audit:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                activity_audit:
                  enabled: true
            .*

  - it: Enable Event Forwarder
    set:
      features:
        investigations:
          event_forwarder:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                event_forwarder:
                  enabled: true
            .*

  - it: Enable Live Logs
    set:
      features:
        investigations:
          live_logs:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                live_logs:
                  enabled: true
            .*

  - it: Enable Network Security
    set:
      features:
        investigations:
          network_security:
            enabled: true
    asserts:
      - matchRegex:
          path: data['host-shield.yaml']
          pattern: |
            .*
                network_security:
                  enabled: true
            .*
