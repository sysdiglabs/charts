suite: Cluster - Service Container Vulnerability Management
templates:
  - templates/cluster/service-container-vulnerability-management.yaml
release:
  name: release-name
  namespace: shield-namespace
values:
  - ../values/base.yaml
tests:
  - it: Does not contain a Service resource when container vulnerability management is disabled
    asserts:
      - hasDocuments:
          count: 0

  - it: Service setup when container vulnerability management is enabled
    set:
      features:
        vulnerability_management:
          container_vulnerability_management:
            enabled: true
    asserts:
      - containsDocument:
          kind: Service
          apiVersion: v1
          name: release-name-shield-cluster-container-vm
      - equal:
          path: metadata.namespace
          value: shield-namespace
      - equal:
          path: spec.type
          value: ClusterIP
      - lengthEqual:
          path: spec.ports
          count: 1
      - isNotNullOrEmpty:
          path: spec.ports[?(@.name == "nats")]
      - equal:
          path: spec.ports[?(@.name == "nats")].port
          value: 4222
      - equal:
          path: spec.ports[?(@.name == "nats")].protocol
          value: TCP
      - equal:
          path: spec.ports[?(@.name == "nats")].targetPort
          value: cvm-nats
      - exists:
          path: spec.ports[?(@.name == "grpc")]
        not: true

  - it: Service setup when admission control with container vulnerability management is enabled
    set:
      features:
        admission_control:
          enabled: true
          container_vulnerability_management:
            enabled: true
    asserts:
      - containsDocument:
          kind: Service
          apiVersion: v1
          name: release-name-shield-cluster-container-vm
      - equal:
          path: metadata.namespace
          value: shield-namespace
      - equal:
          path: spec.type
          value: ClusterIP
      - lengthEqual:
          path: spec.ports
          count: 2
      - isNotNullOrEmpty:
          path: spec.ports[?(@.name == "nats")]
      - equal:
          path: spec.ports[?(@.name == "nats")].port
          value: 4222
      - equal:
          path: spec.ports[?(@.name == "nats")].protocol
          value: TCP
      - equal:
          path: spec.ports[?(@.name == "nats")].targetPort
          value: cvm-nats
      - isNotNullOrEmpty:
          path: spec.ports[?(@.name == "grpc")]
      - equal:
          path: spec.ports[?(@.name == "grpc")].port
          value: 9999
      - equal:
          path: spec.ports[?(@.name == "grpc")].protocol
          value: TCP
      - equal:
          path: spec.ports[?(@.name == "grpc")].targetPort
          value: cvm-grpc
