suite: Cluster - Lease Container Vulnerability Management
templates:
  - templates/cluster/lease-container-vulnerability-management.yaml
release:
  name: release-name
  namespace: shield-namespace
values:
  - ../values/base.yaml
kubernetesProvider:
  scheme:
    "coordination.k8s.io/v1/Lease":
      gvr:
        group: "coordination.k8s.io"
        version: "v1"
        resource: "leases"
      namespaced: true
  objects:
    - apiVersion: coordination.k8s.io/v1
      kind: Lease
      metadata:
        name: existing-lease-name
        namespace: shield-namespace
      spec:
        acquireTime: "2024-07-31T12:55:56.395014Z"
        holderIdentity: shield-cluster-pod-name
        renewTime: "2024-07-31T12:56:16.442859Z"

tests:
  - it: Does not contain a Lease resource when container vulnerability management is disabled
    asserts:
      - hasDocuments:
          count: 0

  - it: Does not contain a Lease resource when lease creation is excluded
    set:
      cluster:
        exclude_lease_creation: true
      features:
        vulnerability_management:
          container_vulnerability_management:
            enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: Contains a Lease resource when container vulnerability management is enabled
    set:
      features:
        vulnerability_management:
          container_vulnerability_management:
            enabled: true
    asserts:
      - containsDocument:
          kind: Lease
          apiVersion: coordination.k8s.io/v1
          name: release-name-shield-cluster-container-vulnerability-management
          namespace: shield-namespace
      - equal:
          path: spec
          value:

  - it: Contains a Lease resource when container vulnerability management is enabled and lease creation is not excluded
    set:
      features:
        vulnerability_management:
          container_vulnerability_management:
            enabled: true
    asserts:
      - containsDocument:
          kind: Lease
          apiVersion: coordination.k8s.io/v1
          name: release-name-shield-cluster-container-vulnerability-management
          namespace: shield-namespace
      - equal:
          path: spec
          value:

  - it: Override Lease name
    set:
      cluster:
        additional_settings:
          cluster_scanner:
            leader_election_lock_name: custom-lease-name
      features:
        vulnerability_management:
          container_vulnerability_management:
            enabled: true
    asserts:
      - containsDocument:
          kind: Lease
          apiVersion: coordination.k8s.io/v1
          name: custom-lease-name
          namespace: shield-namespace
      - equal:
          path: spec
          value:

  - it: Reuse existing lock specs
    set:
      cluster:
        additional_settings:
          cluster_scanner:
            leader_election_lock_name: existing-lease-name
      features:
        vulnerability_management:
          container_vulnerability_management:
            enabled: true
    asserts:
      - containsDocument:
          kind: Lease
          apiVersion: coordination.k8s.io/v1
          name: existing-lease-name
          namespace: shield-namespace
      - equal:
          path: spec
          value:
            acquireTime: "2024-07-31T12:55:56.395014Z"
            holderIdentity: shield-cluster-pod-name
            renewTime: "2024-07-31T12:56:16.442859Z"
